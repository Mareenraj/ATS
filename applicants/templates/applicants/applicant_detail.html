{% extends 'base.html' %}

{% block title %}{{ applicant.full_name }} - ATS{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Applicant Info Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-1">{{ applicant.full_name }}</h4>
                <small>Applied for: {{ applicant.applied_job.title }}</small>
            </div>
            <div class="card-body">
                                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><i class="bi bi-envelope text-primary me-2"></i><strong>Email:</strong> {{ applicant.email }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><i class="bi bi-telephone text-primary me-2"></i><strong>Phone:</strong> {{ applicant.phone }}</p>
                    </div>
                </div>

                {% if applicant.linkedin %}
                <p class="mb-2">
                    <i class="bi bi-linkedin text-primary me-2"></i><strong>LinkedIn:</strong>
                    <a href="{{ applicant.linkedin }}" target="_blank">{{ applicant.linkedin }}</a>
                </p>
                {% endif %}

                                <p class="mb-3">
                    <i class="bi bi-calendar text-primary me-2"></i><strong>Applied:</strong> {{ applicant.applied_at|date:"F d, Y" }}
                </p>
                {% if applicant.cover_letter %}
                <div class="mt-4">
                    <h5 class="text-primary"><i class="bi bi-file-text me-2"></i>Cover Letter</h5>
                    <div class="bg-light p-3 rounded">
                        {{ applicant.cover_letter|linebreaks }}
                    </div>
                </div>
                {% endif %}

                <div class="mt-4">
                    <h5 class="text-primary"><i class="bi bi-file-earmark-pdf me-2"></i>Resume</h5>
                    <a href="{{ applicant.resume.url }}" class="btn btn-outline-primary mb-3" download>
                        <i class="bi bi-download me-1"></i>Download Resume
                    </a>

                    {% if resume_text %}
                    <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                        <pre style="white-space: pre-wrap;">{{ resume_text }}</pre>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- AI Analysis Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI-Powered CV Analysis</h5>
                {% if resume_text and not ai_analysis %}
                <form method="post" class="mb-0" id="ai-analyze-form">
                    {% csrf_token %}
                    <input type="hidden" name="analyze_cv" value="1">
                    <button type="submit" class="btn btn-light btn-sm" id="ai-analyze-btn">
                        <i class="bi bi-magic me-1"></i>Analyze with AI
                    </button>
                </form>
                {% endif %}
            </div>
            <div class="card-body">
                <div id="ai-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-info" role="status"></div>
                    <p class="mt-2 mb-0 text-info fw-bold">Generating AI analysis...</p>
                </div>
                <div id="ai-content">
                {% if ai_analysis %}
                    {% if ai_analysis.success %}
                    <div class="ai-analysis-content">{{ ai_analysis.analysis|linebreaks }}</div>
                    {% elif ai_analysis.error %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>{{ ai_analysis.error }}
                    </div>
                    {% endif %}
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="bi bi-robot" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">Click "Analyze with AI" to compare this CV with the job requirements.</p>
                </div>
                {% endif %}
                </div>
            </div>
        </div>

        <script>
        document.getElementById('ai-analyze-form')?.addEventListener('submit', function() {
            document.getElementById('ai-analyze-btn').disabled = true;
            document.getElementById('ai-analyze-btn').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
            document.getElementById('ai-loading').style.display = 'block';
            document.getElementById('ai-content').style.display = 'none';
        });
        </script>

        <!-- Notes Card -->
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-sticky me-2"></i>Recruiter Notes</h5>
            </div>
            <div class="card-body">
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="add_note" value="1">
                    <div class="mb-3">
                        {{ note_form.note }}
                        {% if note_form.note.errors %}
                        <div class="text-danger small">{{ note_form.note.errors }}</div>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>Add Note
                    </button>
                </form>

                {% if notes %}
                <div class="list-group">
                    {% for note in notes %}
                    <div class="list-group-item">
                        <p class="mb-1">{{ note.note }}</p>
                        <small class="text-muted">
                            By {{ note.created_by.get_full_name|default:note.created_by.username }}
                            on {{ note.created_at|date:"M d, Y H:i" }}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No notes yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Status Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Update Status</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="update_status" value="1">
                    {{ status_form.status }}
                    <button type="submit" class="btn btn-warning w-100 mt-2">
                        <i class="bi bi-check-lg me-1"></i>Update
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="mailto:{{ applicant.email }}" class="btn btn-outline-primary w-100 mb-2">
                    <i class="bi bi-envelope me-1"></i>Send Email
                </a>
                <a href="{% url 'applicants:applicant_list' %}" class="btn btn-outline-secondary w-100 mb-2">
                    <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
                <a href="{% url 'applicants:applicant_delete' applicant.pk %}" class="btn btn-outline-danger w-100">
                    <i class="bi bi-trash me-1"></i>Delete Applicant
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-control,
    .form-select {
        border-radius: 0.375rem;
    }

    textarea.form-control {
        min-height: 100px;
    }
</style>
{% endblock %}